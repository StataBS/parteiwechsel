<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Parteiwechsel</title>
<style>
  #chart {
    height: 500px;
  }

  .node rect {
    cursor: move;
    fill-opacity: .9;
    shape-rendering: crispEdges;
  }

  .node text {
    pointer-events: none;
  }

  .link {
    fill: none;
    stroke: #000;
    stroke-opacity: .4;
  }

  .link:hover {
    stroke-opacity: 0.9;
  }

	.tooltip {
		position: absolute;
		text-align: center;
		width: 80px;
		height: 12px;
		padding: 8px;
		margin-top: -20px;
		font: 10px sans-serif;
		background: #ddd;
		pointer-events: none;
	}

</style>

<body>
  <div id="chart2"></div>  
  <div id="chart"></div>  

  <script src="https://d3js.org/d3.v4.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.4.1"></script>

  <script>

		(function(){	
			var width = 1000;
			var height = 500;
			var nodeWidth = 5;
			var sortBy = 'size';

			var colors = d3.scaleOrdinal()
				.domain(["SD", "VEW", "FraB", "GB", "SVP", "SP", "DSP", "FP", "FDP", "CVP"])
				.range(["rgb(130, 27, 33)", "rgb(255, 215, 0)", "rgb(255, 140, 255)", "rgb(70, 187, 5)", "rgb(0, 128, 0)", "rgb(255, 0, 0)", "rgb(169, 115, 199)", "rgb(191, 179, 128)", "rgb(51, 102, 255)", "rgb(255, 153, 0)"])
				;

			d3.json("parteiwechsel.json", function(data) {
				var selection = d3.select("#chart2").append("svg")
				var formatNumber = d3.format(",.0f"),
						format = function(d) { return formatNumber(d); };

				var g = selection
						.attr("width", +width)
						.attr("height", +height + 20 )
						.append("g")
						.attr("transform", "translate(" + 0 + "," + 10 + ")");

				// Calculating the best nodePadding

				var nested = d3.nest()
						.key(function (d){ return d.group; })
						.rollup(function (d){ return d.length; })
						.entries(data.nodes)

				var maxNodes = d3.max(nested, function (d){ return d.values; });

				var sankey = d3.sankey()
						.nodeWidth(+nodeWidth)
						.nodePadding(d3.min([10,(height-maxNodes)/maxNodes]))
						.size([+width, +height]);

				var path = sankey.link(),
					nodes = data.nodes,
					links = data.links;

				sankey
						.nodes(nodes)
						.links(links)
						.layout(32);

					// Re-sorting nodes

					nested = d3.nest()
						.key(function(d){ return d.group; })
						.map(nodes);

					d3.values(nested)
						.filter(function(d){return d instanceof Array})
						.forEach(function (d){
							var y = ( height - d3.sum(d,function(n){ return n.dy+sankey.nodePadding();}) ) / 2 + sankey.nodePadding()/2;
							d.sort(function (a,b){
								if (sortBy == "automatic") return b.y - a.y;
								if (sortBy == "size") return b.dy - a.dy;
								if (sortBy == "name") return a.name < b.name ? -1 : a.name > b.name ? 1 : 0;
							})          
							d.forEach(function (node){
								node.y = y;
								y += node.dy +sankey.nodePadding();
							})
						})

					// Resorting links

				d3.values(nested).filter(function(d){return d instanceof Array}).forEach(function (d){

					d.forEach(function (node){

							var ly = 0;
							node.sourceLinks
								.sort(function (a,b){
									return a.target.y - b.target.y;
								})
								.forEach(function (link){
									link.sy = ly;
									ly += link.dy;
								})

							ly = 0;

							node.targetLinks
								.sort(function(a,b){
									return a.source.y - b.source.y;
								})
								.forEach(function (link){
									link.ty = ly;
									ly += link.dy;
								})
					})
				})


				var link = g.append("g").selectAll(".link")
						.data(links)
						.enter().append("path")
							.attr("class", "link")
							.attr("d", path )
							.style("stroke-width", function(d) { return Math.max(1, d.dy); })
							.style("fill","none")
							.style("stroke", function (d){ return colors(d.source.name); })
							.sort(function(a, b) { return b.dy - a.dy; })

							.on("mouseover", mouseover)
							.on("mousemove", d => mousemove(d))
							.on("mouseout", mouseout)

							/*			    
							.append("title")
							.text(function(d) {return d.value})        
							*/
							;

				var div = d3.select("body").append("div")
						.attr("class", "tooltip")
						.style("display", "none");

				function mouseover() {
					div.style("display", "inline");
				}

				function mousemove(d) {
					div
							.html(d.source.name + " â†’ " + d.target.name + ": <strong>" + format(d.value) + "</strong>")
							.style("left", (d3.event.pageX - 34) + "px")
							.style("top", (d3.event.pageY - 12) + "px");
				}

				function mouseout() {
					div.style("display", "none");
				}


				var node = g.append("g").selectAll(".node")
						.data(nodes)
						.enter().append("g")
								.attr("class", "node")
								.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })

				node.append("text")
						.attr("x", -6)
							.attr("y", function (d) { return d.dy / 2; })
							.attr("dy", ".35em")
							.attr("text-anchor", "end")
							.attr("transform", null)
							.text(function(d) { return d.name; })
							.style("font-size","11px")
						.style("font-family","Arial, Helvetica")
							.style("pointer-events","none")
							.filter(function(d) { return d.x < +width / 2; })
							.attr("x", 6 + sankey.nodeWidth())
							.attr("text-anchor", "start");
			})
		}())

  </script>

